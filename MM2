-- MM2 ESP Script with Rayfield Interface
-- Load Rayfield Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "MM2 ESP",
    LoadingTitle = "Murder Mystery 2 ESP",
    LoadingSubtitle = "By 266",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "MM2_ESP",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Create Tabs
local vTab = Window:CreateTab("Visuals", "eye")  -- Lucide icon "eye"

-- ESP Variables
local espFolder = Instance.new("Folder")
espFolder.Name = "ESP_Folder"
espFolder.Parent = game:GetService("CoreGui")

local espSettings = {
    Enabled = false,
    ShowSheriff = true,
    ShowMurderer = true,
    ShowInnocent = true,
    ShowNeutral = true,
    Tracers = false,
    ShowDistance = true,
    MaxDistance = 500,
}

-- Role tracking
local playerRoles = {}
local roleColors = {
    Innocent = Color3.fromRGB(0, 255, 0),      -- Green
    Sheriff = Color3.fromRGB(0, 0, 255),       -- Blue
    Murderer = Color3.fromRGB(255, 0, 0),      -- Red
    Neutral = Color3.fromRGB(255, 255, 255),   -- White
    Hero = Color3.fromRGB(0, 150, 255),        -- Light Blue (for hero - picked up sheriff gun)
}

-- Get remote references
local Remotes = game:GetService("ReplicatedStorage"):WaitForChild("Remotes")
local GameplayRemote = Remotes:WaitForChild("Gameplay")
local RoleSelectRemote = GameplayRemote:WaitForChild("RoleSelect")

-- Hook into RoleSelect to detect roles
local originalRoleSelect
originalRoleSelect = hookfunction(RoleSelectRemote.OnClientEvent, function(self, role, ...)
    -- Store player's role
    local player = game.Players.LocalPlayer
    playerRoles[player] = role
    
    -- Call original function
    return originalRoleSelect(self, role, ...)
end)

-- Function to check if player has sheriff gun (hero)
local function isPlayerHero(player)
    if player and player.Character then
        -- Check for gun in character
        local gun = player.Character:FindFirstChild("Gun") or player.Character:FindFirstChildWhichIsA("Tool")
        if gun then
            -- Check if it's a sheriff gun by name or properties
            local gunName = gun.Name:lower()
            if gunName:find("gun") or gunName:find("revolver") or gunName:find("pistol") then
                return true
            end
        end
        
        -- Check backpack for gun
        local backpack = player:FindFirstChild("Backpack")
        if backpack then
            for _, tool in ipairs(backpack:GetChildren()) do
                if tool:IsA("Tool") and (tool.Name:find("Gun") or tool.Name:find("Revolver")) then
                    return true
                end
            end
        end
    end
    return false
end

-- Create ESP box for a player
local function createESP(player)
    if not player or not player.Character then return end
    
    -- Remove existing ESP
    local existing = espFolder:FindFirstChild(player.Name)
    if existing then existing:Destroy() end
    
    local espHolder = Instance.new("Folder")
    espHolder.Name = player.Name
    espHolder.Parent = espFolder
    
    -- Create billboard for name/role
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPBillboard"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = espSettings.MaxDistance
    billboard.Parent = espHolder
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "ESPText"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = player.Name
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextStrokeTransparency = 0.5
    textLabel.TextSize = 14
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Parent = billboard
    
    -- Create highlight for player
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.FillTransparency = 0.8
    highlight.OutlineTransparency = 0
    highlight.Parent = espHolder
    
    -- Create tracer line
    if espSettings.Tracers then
        local tracer = Instance.new("Frame")
        tracer.Name = "ESPTracer"
        tracer.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        tracer.BorderSizePixel = 0
        tracer.Parent = espHolder
    end
    
    -- Function to update ESP appearance
    local function updateESP()
        if not player or not player.Character then return end
        
        -- Determine player's role
        local role = playerRoles[player] or "Neutral"
        local isHero = false
        
        -- Check for hero status (has sheriff gun)
        if role == "Innocent" and isPlayerHero(player) then
            role = "Hero"
            isHero = true
        end
        
        -- Check if ESP should be shown for this role
        local shouldShow = espSettings.Enabled and (
            (role == "Sheriff" and espSettings.ShowSheriff) or
            (role == "Murderer" and espSettings.ShowMurderer) or
            (role == "Innocent" and espSettings.ShowInnocent) or
            (role == "Neutral" and espSettings.ShowNeutral) or
            (isHero and espSettings.ShowSheriff)  -- Heroes use sheriff ESP setting
        )
        
        -- Set visibility
        billboard.Enabled = shouldShow
        highlight.Enabled = shouldShow
        
        if shouldShow then
            -- Set colors based on role
            local color = roleColors[role] or roleColors.Neutral
            highlight.FillColor = color
            highlight.OutlineColor = color
            textLabel.TextColor3 = color
            
            -- Update text with role and distance
            local localPlayer = game.Players.LocalPlayer
            local distance = ""
            
            if espSettings.ShowDistance and localPlayer.Character then
                local localRoot = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                local playerRoot = player.Character:FindFirstChild("HumanoidRootPart")
                
                if localRoot and playerRoot then
                    local dist = (localRoot.Position - playerRoot.Position).Magnitude
                    distance = string.format(" [%d]", math.floor(dist))
                end
            end
            
            textLabel.Text = string.format("%s - %s%s", player.Name, role, distance)
            
            -- Attach to player's head
            local head = player.Character:FindFirstChild("Head")
            if head then
                billboard.Adornee = head
                highlight.Adornee = player.Character
            end
        end
    end
    
    -- Update ESP periodically
    local connection
    connection = game:GetService("RunService").Heartbeat:Connect(function()
        if not player or not player.Character or player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health <= 0 then
            -- Player died or left
            espHolder:Destroy()
            if connection then connection:Disconnect() end
            return
        end
        
        updateESP()
        
        -- Update tracer if enabled
        if espSettings.Tracers then
            local tracer = espHolder:FindFirstChild("ESPTracer")
            if tracer then
                -- Tracer logic would go here
                -- This requires more complex UI code
            end
        end
    end)
end

-- Monitor players
local function monitorPlayers()
    -- Create ESP for existing players
    for _, player in ipairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            createESP(player)
        end
    end
    
    -- Listen for new players
    game.Players.PlayerAdded:Connect(function(player)
        wait(1)  -- Wait for character to load
        createESP(player)
    end)
    
    -- Listen for role changes (when sheriff dies and gun is picked up)
    game:GetService("RunService").Heartbeat:Connect(function()
        for _, player in ipairs(game.Players:GetPlayers()) do
            if player ~= game.Players.LocalPlayer then
                -- Check if innocent became hero by picking up gun
                if playerRoles[player] == "Innocent" and isPlayerHero(player) then
                    playerRoles[player] = "Hero"
                end
                -- Check if hero died and lost gun
                if playerRoles[player] == "Hero" and not isPlayerHero(player) then
                    playerRoles[player] = "Innocent"
                end
            end
        end
    end)
end

-- Start monitoring
monitorPlayers()

-- Create ESP Controls Section
local Section = vTab:CreateSection("ESP Controls")

-- Master ESP Toggle
local ESPToggle = vTab:CreateToggle({
    Name = "Enable ESP",
    CurrentValue = false,
    Flag = "ESPEnabled",
    Callback = function(Value)
        espSettings.Enabled = Value
    end,
})

-- Role-specific ESP toggles
local SheriffToggle = vTab:CreateToggle({
    Name = "Show Sheriff/Hero",
    CurrentValue = true,
    Flag = "ShowSheriff",
    Callback = function(Value)
        espSettings.ShowSheriff = Value
    end,
})

local MurdererToggle = vTab:CreateToggle({
    Name = "Show Murderer",
    CurrentValue = true,
    Flag = "ShowMurderer",
    Callback = function(Value)
        espSettings.ShowMurderer = Value
    end,
})

local InnocentToggle = vTab:CreateToggle({
    Name = "Show Innocent",
    CurrentValue = true,
    Flag = "ShowInnocent",
    Callback = function(Value)
        espSettings.ShowInnocent = Value
    end,
})

local NeutralToggle = vTab:CreateToggle({
    Name = "Show Neutral",
    CurrentValue = true,
    Flag = "ShowNeutral",
    Callback = function(Value)
        espSettings.ShowNeutral = Value
    end,
})

-- ESP Features Section
vTab:CreateSection("ESP Features")

local TracerToggle = vTab:CreateToggle({
    Name = "Tracers",
    CurrentValue = false,
    Flag = "ShowTracers",
    Callback = function(Value)
        espSettings.Tracers = Value
    end,
})

local DistanceToggle = vTab:CreateToggle({
    Name = "Show Distance",
    CurrentValue = true,
    Flag = "ShowDistance",
    Callback = function(Value)
        espSettings.ShowDistance = Value
    end,
})

local DistanceSlider = vTab:CreateSlider({
    Name = "Max Distance",
    Range = {100, 1000},
    Increment = 50,
    Suffix = "studs",
    CurrentValue = 500,
    Flag = "MaxDistance",
    Callback = function(Value)
        espSettings.MaxDistance = Value
        -- Update all ESP billboards
        for _, esp in ipairs(espFolder:GetChildren()) do
            local billboard = esp:FindFirstChild("ESPBillboard")
            if billboard then
                billboard.MaxDistance = Value
            end
        end
    end,
})

-- Quick Toggle Presets Section
vTab:CreateSection("Quick Presets")

vTab:CreateButton({
    Name = "All Roles",
    Callback = function()
        SheriffToggle:Set(true)
        MurdererToggle:Set(true)
        InnocentToggle:Set(true)
        NeutralToggle:Set(true)
    end,
})

vTab:CreateButton({
    Name = "Enemies Only",
    Callback = function()
        SheriffToggle:Set(true)
        MurdererToggle:Set(true)
        InnocentToggle:Set(false)
        NeutralToggle:Set(false)
    end,
})

vTab:CreateButton({
    Name = "Team Only",
    Callback = function()
        -- This would need to know local player's role
        -- For now, show sheriff and innocent
        SheriffToggle:Set(true)
        MurdererToggle:Set(false)
        InnocentToggle:Set(true)
        NeutralToggle:Set(false)
    end,
})

vTab:CreateButton({
    Name = "Clear All ESP",
    Callback = function()
        for _, child in ipairs(espFolder:GetChildren()) do
            child:Destroy()
        end
    end,
})

-- Debug/Info Section
vTab:CreateSection("Debug Info")

local InfoParagraph = vTab:CreateParagraph({
    Title = "ESP Information",
    Content = "ESP tracks player roles from game events. Heroes are detected when innocents pick up sheriff guns. Roles update automatically when game state changes."
})

-- Function to force refresh ESP
vTab:CreateButton({
    Name = "Refresh ESP",
    Callback = function()
        -- Clear existing ESP
        for _, child in ipairs(espFolder:GetChildren()) do
            child:Destroy()
        end
        
        -- Recreate ESP for all players
        for _, player in ipairs(game.Players:GetPlayers()) do
            if player ~= game.Players.LocalPlayer then
                createESP(player)
            end
        end
    end,
})

-- Notify user
Rayfield:Notify({
    Title = "MM2 ESP Loaded",
    Content = "ESP system initialized. Roles will be detected automatically.",
    Duration = 5,
    Image = "eye",
})

-- Load configuration
Rayfield:LoadConfiguration()
