-- Performance Monitor for Eclipse Hub Detection
-- Run this FIRST, then run your Eclipse Hub

local Stats = game:GetService("Stats")
local NetworkClient = game:GetService("NetworkClient")
local RunService = game:GetService("RunService")

-- Configuration
local MONITOR_TIME = 10  -- Monitor for 10 seconds
local THRESHOLD_PING = 200  -- Alert if ping > 200ms
local THRESHOLD_FPS = 15    -- Alert if FPS < 15

-- Tracking variables
local startTime = os.clock()
local logs = {}
local maxPing = 0
local minFPS = 60
local alertCount = 0

-- Get current ping in milliseconds
local function getPing()
    return NetworkClient:GetServerResponseTime() * 1000
end

-- Get current FPS
local function getFPS()
    local fps = 0
    local success = pcall(function()
        fps = 1 / RunService.RenderStepped:Wait()
    end)
    return math.floor(fps)
end

-- Get current memory usage
local function getMemory()
    return Stats:GetTotalMemoryUsageMb()
end

-- Simple monitoring function
local function monitorPerformance()
    print("=== Starting Performance Monitor ===")
    print("Will monitor for " .. MONITOR_TIME .. " seconds")
    print("Waiting 2 seconds for baseline...")
    
    -- Get baseline (first 2 seconds)
    local baselinePing = 0
    local baselineMemory = 0
    local baselineFPS = 0
    local baselineSamples = 0
    
    for i = 1, 40 do
        baselinePing = baselinePing + getPing()
        baselineMemory = baselineMemory + getMemory()
        baselineFPS = baselineFPS + getFPS()
        baselineSamples = baselineSamples + 1
        task.wait(0.05)
    end
    
    baselinePing = baselinePing / baselineSamples
    baselineMemory = baselineMemory / baselineSamples
    baselineFPS = baselineFPS / baselineSamples
    
    print(string.format("Baseline: Ping=%.1fms, Memory=%.1fMB, FPS=%.1f", 
        baselinePing, baselineMemory, baselineFPS))
    
    print("\n=== NOW RUN YOUR ECLIPSE HUB SCRIPT ===")
    print("Monitoring will continue for " .. MONITOR_TIME .. " seconds...\n")
    
    -- Main monitoring loop
    local monitorStart = os.clock()
    while os.clock() - monitorStart < MONITOR_TIME do
        local currentTime = os.clock() - monitorStart
        local ping = getPing()
        local memory = getMemory()
        local fps = getFPS()
        
        -- Track extremes
        if ping > maxPing then maxPing = ping end
        if fps < minFPS and fps > 0 then minFPS = fps end
        
        -- Check for issues
        local hasIssue = false
        local issues = {}
        
        if ping > baselinePing + THRESHOLD_PING then
            table.insert(issues, "High ping: " .. math.floor(ping) .. "ms")
            hasIssue = true
        end
        
        if fps < THRESHOLD_FPS and fps > 0 then
            table.insert(issues, "Low FPS: " .. fps)
            hasIssue = true
        end
        
        -- Log this sample
        local logEntry = {
            time = currentTime,
            ping = ping,
            memory = memory,
            fps = fps,
            hasIssue = hasIssue,
            issues = #issues > 0 and issues or nil
        }
        
        table.insert(logs, logEntry)
        
        -- Show alert if issues found
        if hasIssue then
            alertCount = alertCount + 1
            print(string.format("[ALERT %d] t=%.1fs: %s", 
                alertCount, currentTime, table.concat(issues, ", ")))
        end
        
        -- Show progress every 2 seconds
        if math.floor(currentTime) % 2 == 0 and math.floor(currentTime) ~= math.floor(currentTime - 0.1) then
            print(string.format("[%.1f/%.1fs] Ping: %dms, FPS: %d", 
                currentTime, MONITOR_TIME, math.floor(ping), fps))
        end
        
        task.wait(0.1)  -- Check every 100ms
    end
    
    -- Generate final report
    print("\n" .. string.rep("=", 50))
    print("FINAL REPORT")
    print(string.rep("=", 50))
    
    print("Monitoring duration: " .. MONITOR_TIME .. " seconds")
    print("Baseline ping: " .. string.format("%.1fms", baselinePing))
    print("Maximum ping: " .. math.floor(maxPing) .. "ms")
    print("Minimum FPS: " .. minFPS)
    print("Total alerts: " .. alertCount)
    
    -- Find the worst period
    local worstStart = 0
    local worstEnd = 0
    local worstAlertCount = 0
    local currentAlertCount = 0
    local currentStart = 0
    
    for i, log in ipairs(logs) do
        if log.hasIssue then
            if currentAlertCount == 0 then
                currentStart = log.time
            end
            currentAlertCount = currentAlertCount + 1
        else
            if currentAlertCount > worstAlertCount then
                worstAlertCount = currentAlertCount
                worstStart = currentStart
                worstEnd = log.time
            end
            currentAlertCount = 0
        end
    end
    
    if worstAlertCount > 0 then
        local duration = worstEnd - worstStart
        print("\nâš ï¸  WORST PERFORMANCE PERIOD:")
        print("   Start: " .. string.format("%.1fs", worstStart))
        print("   End: " .. string.format("%.1fs", worstEnd))
        print("   Duration: " .. string.format("%.1f seconds", duration))
        print("   Alerts during period: " .. worstAlertCount)
        
        if duration > 3 then
            print("\nðŸŽ¯ THIS IS LIKELY THE EXPLOIT LOADING!")
            print("   The freeze matches your screenshot (4-5 seconds)")
        end
    end
    
    -- Summary
    print("\n" .. string.rep("-", 50))
    if alertCount > 10 then
        print("âœ… STRONG EXPLOIT SIGNATURE DETECTED!")
        print("   Multiple performance alerts found")
    elseif alertCount > 0 then
        print("âš ï¸  SOME PERFORMANCE ISSUES DETECTED")
        print("   May indicate exploit activity")
    else
        print("ðŸ“Š NO SIGNIFICANT PERFORMANCE ISSUES")
        print("   Either exploit didn't load or is very efficient")
    end
    
    print("\nTo use this for anti-cheat:")
    print("1. Freeze duration: " .. (worstEnd - worstStart > 0 and string.format("%.1f seconds", worstEnd - worstStart) or "Not detected"))
    print("2. Ping threshold: " .. THRESHOLD_PING .. "ms above baseline")
    print("3. FPS threshold: " .. THRESHOLD_FPS .. " FPS minimum")
    
    return logs
end

-- Start monitoring
local success, result = pcall(monitorPerformance)

if not success then
    print("Error running monitor: " .. tostring(result))
    print("Trying simplified version...")
    
    -- Fallback simple version
    print("Simple monitor - checking for freezes...")
    local checkpoints = {}
    for i = 1, 50 do
        table.insert(checkpoints, os.clock())
        task.wait(0.1)
        local elapsed = os.clock() - checkpoints[#checkpoints]
        if elapsed > 0.2 then  -- If wait took too long
            print(string.format("FREEZE DETECTED! Frame %d took %.2f seconds", i, elapsed))
        end
    end
end
