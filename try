-- Executor Performance Sniffer for Eclipse Hub
-- Run this IN YOUR EXECUTOR before the hub script

print("=== EXECUTOR FREEZE DETECTOR ===")
print("Starting detection for Eclipse Hub loading...")
print("Will monitor for 15 seconds")
print()

-- Configuration
local FREEZE_THRESHOLD = 0.3  -- Seconds - normal frames are 0.016s
local LONG_FREEZE_THRESHOLD = 1.0  -- Seconds for major freezes
local TOTAL_MONITOR_TIME = 15  -- Seconds to monitor

-- Trackers
local freezeLog = {}
local startTime = tick()
local lastCheck = tick()
local totalFreezeTime = 0
local freezeCount = 0

-- Simple check using tick()
local function checkForFreeze()
    local currentTime = tick()
    local frameTime = currentTime - lastCheck
    
    if frameTime > FREEZE_THRESHOLD then
        local severity = "MINOR"
        if frameTime > LONG_FREEZE_THRESHOLD then
            severity = "MAJOR"
        end
        
        table.insert(freezeLog, {
            time = currentTime - startTime,
            duration = frameTime,
            severity = severity
        })
        
        totalFreezeTime = totalFreezeTime + frameTime
        freezeCount = freezeCount + 1
        
        print(string.format("[FREEZE] t=%.2fs: %.3fs %s", 
            currentTime - startTime, frameTime, severity))
    end
    
    lastCheck = currentTime
end

-- Method 1: Use executor's task.wait if available
if task and task.wait then
    print("Using task.wait() monitoring...")
    
    for i = 1, (TOTAL_MONITOR_TIME * 60) do  -- About 60 FPS
        checkForFreeze()
        task.wait(1/60)  -- Try to wait 1 frame
    end
    
-- Method 2: Use basic while loop
else
    print("Using basic timing loop...")
    local monitorEnd = tick() + TOTAL_MONITOR_TIME
    
    while tick() < monitorEnd do
        checkForFreeze()
        -- Small delay to prevent CPU overload
        if wait then
            wait(1/60)
        else
            -- Busy wait as fallback
            local target = tick() + 1/60
            while tick() < target do end
        end
    end
end

-- Generate Report
print("\n" .. string.rep("=", 50))
print("FREEZE DETECTION REPORT")
print(string.rep("=", 50))

print("Monitoring duration: " .. TOTAL_MONITOR_TIME .. " seconds")
print("Total freezes detected: " .. freezeCount)
print("Total freeze time: " .. string.format("%.2f seconds", totalFreezeTime))
print("Percentage frozen: " .. string.format("%.1f%%", (totalFreezeTime / TOTAL_MONITOR_TIME) * 100))

-- Find the longest freeze
if #freezeLog > 0 then
    table.sort(freezeLog, function(a, b)
        return a.duration > b.duration
    end)
    
    print("\nTOP 3 FREEZES:")
    for i = 1, math.min(3, #freezeLog) do
        local freeze = freezeLog[i]
        print(string.format("%d. %.3fs at t=%.2fs (%s)", 
            i, freeze.duration, freeze.time, freeze.severity))
    end
    
    -- Look for the "Eclipse Hub loading" pattern
    local hubFreezeDetected = false
    for _, freeze in ipairs(freezeLog) do
        if freeze.duration > 2.5 and freeze.duration < 6.0 then
            hubFreezeDetected = true
            print("\nðŸŽ¯ ECLIPSE HUB SIGNATURE DETECTED!")
            print(string.format("   Found %.3fs freeze at t=%.2fs", 
                freeze.duration, freeze.time))
            print("   This matches the hub loading time")
            break
        end
    end
    
    if not hubFreezeDetected then
        print("\nâš ï¸ No hub loading signature found")
        print("   (Either didn't load or was very fast)")
    end
else
    print("\nðŸ“Š No significant freezes detected")
end

-- Calculate anti-cheat thresholds
print("\n" .. string.rep("-", 50))
print("ANTI-CHEAT THRESHOLDS SUGGESTED:")
print("1. Freeze detection: >" .. FREEZE_THRESHOLD .. "s")
print("2. Major freeze: >" .. LONG_FREEZE_THRESHOLD .. "s")
print("3. Hub signature: 2.5s - 6.0s freeze")

-- Suggest detection logic
print("\nDETECTION LOGIC:")
print("if freeze > 2.5s and freeze < 6.0s then")
print("   -- Eclipse Hub loading detected")
print("   kickPlayer()")
print("end")

-- Save data if writefile is available
if writefile then
    local csv = "Time,Duration,Severity\n"
    for _, freeze in ipairs(freezeLog) do
        csv = csv .. string.format("%.2f,%.3f,%s\n", 
            freeze.time, freeze.duration, freeze.severity)
    end
    writefile("freeze_log.csv", csv)
    print("\nðŸ“ Data saved to 'freeze_log.csv'")
end

print("\n=== NOW RUN ECLIPSE HUB TO TEST ===")
print("Then compare freeze times with above report")
