warn("v4")

local logs = {}
local startTime = os.clock()

local function safeLog(event, details)
    local timestamp = string.format("[%.3f]", os.clock() - startTime)
    local entry = timestamp .. " " .. event .. ": " .. details
    table.insert(logs, entry)
    print(entry)
end

-- Monitor only, don't modify anything
local function passiveMonitor()
    safeLog("ANALYSIS", "Passive monitor started - waiting for Eclipse")
    
    -- Store original functions to check if they change
    local originals = {
        getgenv = getgenv,
        loadstring = loadstring,
        getrenv = getrenv,
        debug_getconstants = debug.getconstants
    }
    
    -- Check every 0.1 seconds for changes
    local checkInterval = 0.1
    local lastCheck = os.clock()
    
    local monitorThread
    monitorThread = coroutine.create(function()
        while true do
            local now = os.clock()
            if now - lastCheck >= checkInterval then
                -- Check if functions have been hooked/modified
                if getgenv and getgenv ~= originals.getgenv then
                    safeLog("DETECTION", "getgenv was modified!")
                end
                
                if loadstring and loadstring ~= originals.loadstring then
                    safeLog("DETECTION", "loadstring was hooked!")
                end
                
                if debug.getconstants and debug.getconstants ~= originals.debug_getconstants then
                    safeLog("DETECTION", "debug.getconstants was hooked!")
                end
                
                -- Check for Eclipse signature: mainKey in getgenv
                if getgenv and type(getgenv()) == "table" then
                    local env = getgenv()
                    if env.mainKey and tostring(env.mainKey):match("^p95c") then
                        safeLog("DETECTION", "Eclipse Hub mainKey found: " .. tostring(env.mainKey))
                    end
                end
                
                lastCheck = now
            end
            wait(checkInterval)
        end
    end)
    
    coroutine.resume(monitorThread)
    
    return function()
        safeLog("SUMMARY", "=== Analysis Complete ===")
        safeLog("SUMMARY", "Total log entries: " .. #logs)
        
        -- Count Eclipse-specific patterns
        local eclipsePatterns = {
            mainKey = 0,
            getrenv = 0,
            bytecode_load = 0,
            getgenv_mod = 0
        }
        
        for _, log in ipairs(logs) do
            if log:find("mainKey") then eclipsePatterns.mainKey = eclipsePatterns.mainKey + 1 end
            if log:find("getrenv") then eclipsePatterns.getrenv = eclipsePatterns.getrenv + 1 end
            if log:find("bytecode") then eclipsePatterns.bytecode_load = eclipsePatterns.bytecode_load + 1 end
            if log:find("getgenv.*modif") then eclipsePatterns.getgenv_mod = eclipsePatterns.getgenv_mod + 1 end
        end
        
        for pattern, count in pairs(eclipsePatterns) do
            if count > 0 then
                safeLog("PATTERN", pattern .. ": " .. count .. " occurrences")
            end
        end
        
        -- Save to file
        writefile("eclipse_analysis_safe.txt", table.concat(logs, "\n"))
        safeLog("FILE", "Logs saved to eclipse_analysis_safe.txt")
    end
end

-- Run monitor
local printSummary = passiveMonitor()

print("\n" .. string.rep("=", 60))
print("SAFE Eclipse Hub Monitor Running")
print("=" .. string.rep("=", 59))
print("\nThis monitor will NOT crash Eclipse Hub")
print("It passively watches for Eclipse signatures:")
print("1. mainKey in getgenv()")
print("2. getrenv() calls")
print("3. loadstring() with bytecode")
print("4. Function hooking patterns")
print("\nRun Eclipse Hub now...")
print("After it loads, call: printSummary()")
print(string.rep("=", 60) .. "\n")

-- Make summary available
if getgenv then
    getgenv().printSummary = printSummary
end

return printSummary
