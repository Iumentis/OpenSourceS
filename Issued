local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

-- =============================================
-- TIER 1: HOOK ALL DROWN-RELATED FUNCTIONS
-- =============================================
local hookedFunctions = {}

local function safeHook(module, functionName, replacement)
    if not module then return false end
    local original = module[functionName]
    if not original then return false end
    hookedFunctions[functionName] = original
    module[functionName] = replacement
    return true
end

-- Load modules safely
local DrownUtils, DrownConsts
for i = 1, 5 do
    local success1, result1 = pcall(require, ReplicatedStorage:WaitForChild("Drown", 2):WaitForChild("DrownUtils", 2))
    local success2, result2 = pcall(require, ReplicatedStorage:WaitForChild("Drown", 2):WaitForChild("DrownConsts", 2))
    if success1 then DrownUtils = result1 end
    if success2 then DrownConsts = result2 end
    if DrownUtils and DrownConsts then break end
    task.wait(0.5)
end

if DrownUtils then
    -- Hook 1: Always report 0% drowning
    safeHook(DrownUtils, "getDrownPercent", function(player)
        if player == localPlayer then return 0 end
        return hookedFunctions.getDrownPercent(player)
    end)

    -- Hook 2: Never appear to be drowning
    safeHook(DrownUtils, "getIsPlayerDrowning", function(player)
        if player == localPlayer then return false end
        return hookedFunctions.getIsPlayerDrowning(player)
    end)
    print("âœ“ Core functions hooked")
end

-- =============================================
-- TIER 2: CONTINUOUS ATTRIBUTE RESETTING
-- =============================================
local function continuousAttributeReset()
    local lastReset = tick()
    RunService.Heartbeat:Connect(function()
        local character = localPlayer.Character
        if not character then return end
        local head = character:FindFirstChild("Head")
        if not head then return end

        if head.Position.Y < 180 then 
            if tick() - lastReset > 0.05 then
                pcall(function()
                    localPlayer:SetAttribute("DrownPercent", 0)
                    if DrownUtils and DrownUtils.setDrownPercent then
                        DrownUtils.setDrownPercent(localPlayer, 0)
                    end
                end)
                lastReset = tick()
            end
        end
    end)
end
task.spawn(continuousAttributeReset)

-- =============================================
-- TIER 3: POSITION SPOOFING (FIXED)
-- =============================================
local function positionSpoofing()
    RunService.Heartbeat:Connect(function()
        local character = localPlayer.Character
        if not character then return end
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then return end

        if humanoidRootPart.Position.Y < 180 then
            pcall(function()
                -- Attempt to push velocity up to counteract sinking
                humanoidRootPart.Velocity = Vector3.new(0, 5, 0)
                
                -- Note: SetNetworkOwner is usually server-side, 
                -- but included here to match your original logic.
                if humanoidRootPart.SetNetworkOwner then
                    -- humanoidRootPart:SetNetworkOwner(localPlayer) 
                end
            end)
        end -- Added missing 'end' for the IF statement
    end)
end
task.spawn(positionSpoofing)

-- =============================================
-- TIER 4: PACKET MANIPULATION
-- =============================================
local function interceptDrownPackets()
    for _, child in pairs(ReplicatedStorage:GetDescendants()) do
        if child:IsA("RemoteEvent") and (child.Name:find("Drown") or child.Name:find("Water")) then
            print("Found drown-related RemoteEvent:", child:GetFullName())
            local originalFire = child.FireServer
            child.FireServer = function(self, ...)
                local args = {...}
                for i, arg in ipairs(args) do
                    if type(arg) == "number" and (arg > 0 and arg <= 1) then
                        args[i] = 0
                    end
                end
                return originalFire(self, table.unpack(args))
            end
        end
    end
end

if pcall(function() return getrawmetatable(game) end) then
    task.spawn(interceptDrownPackets)
end

-- =============================================
-- TIER 5: VISUAL CLEANUP
-- =============================================
local function removeVisualEffects()
    while true do
        task.wait(0.5)
        local character = localPlayer.Character
        if character then
            local head = character:FindFirstChild("Head")
            if head then
                for _, child in pairs(head:GetChildren()) do
                    if child:IsA("ParticleEmitter") then
                        child:Destroy()
                    end
                end
            end

            local playerGui = localPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                local drownGui = playerGui:FindFirstChild("DrownGui")
                if drownGui then
                    drownGui.Enabled = false
                end
            end
        end
    end
end
task.spawn(removeVisualEffects)

-- =============================================
-- TEST SUITE
-- =============================================
local function runTest()
    print("\nðŸ§ª Starting 30-second underwater test...")
    local character = localPlayer.Character
    if not character or not character:FindFirstChild("Humanoid") then 
        print("âŒ Test failed: Character not found")
        return 
    end
    
    local startHealth = character.Humanoid.Health
    local startTime = tick()

    while tick() - startTime < 30 do
        task.wait(1)
        if character and character:FindFirstChild("Humanoid") and character.Humanoid.Health < startHealth then
            print("âŒ Damage detected at " .. math.floor(tick() - startTime) .. " seconds!")
            return false
        end
    end
    print("âœ“ No damage for 30 seconds!")
    return true
end

print("========================================")
print("DROWN PROTECTION ACTIVE")
print("========================================")
task.wait(2)
task.spawn(runTest)
